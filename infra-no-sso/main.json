{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2956491209652021276"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location for all resources."
      }
    },
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "proposalgen",
      "metadata": {
        "description": "A common prefix for all resource names."
      }
    },
    "backendImage": {
      "type": "string",
      "defaultValue": "backend:latest",
      "metadata": {
        "description": "The Docker image for the backend app."
      }
    },
    "environmentSize": {
      "type": "string",
      "defaultValue": "Testing",
      "allowedValues": [
        "Testing",
        "Exploratory",
        "Expanded",
        "Organization-Wide"
      ],
      "metadata": {
        "description": "The size of the environment to deploy."
      }
    },
    "serperApiKey": {
      "type": "securestring"
    },
    "secretKey": {
      "type": "securestring"
    },
    "cfAccessClientId": {
      "type": "string"
    },
    "cfAccessClientSecret": {
      "type": "securestring"
    }
  },
  "resources": {
    "acr": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "acrDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "prefix": {
            "value": "[parameters('resourcePrefix')]"
          },
          "environmentSize": {
            "value": "[parameters('environmentSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "344403952347723317"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the container registry."
              }
            },
            "prefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for the container registry name."
              }
            },
            "environmentSize": {
              "type": "string",
              "metadata": {
                "description": "The size of the environment to deploy."
              }
            }
          },
          "variables": {
            "acrName": "[format('{0}acr{1}', parameters('prefix'), uniqueString(resourceGroup().id))]",
            "acrSkus": {
              "Testing": "Standard",
              "Exploratory": "Standard",
              "Expanded": "Premium",
              "Organization-Wide": "Premium"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[variables('acrName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[variables('acrSkus')[parameters('environmentSize')]]"
              },
              "tags": {
                "Environment": "Dev"
              },
              "properties": {
                "adminUserEnabled": true
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[variables('acrName')]"
            }
          }
        }
      }
    },
    "postgres": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "postgresDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "prefix": {
            "value": "[parameters('resourcePrefix')]"
          },
          "environmentSize": {
            "value": "[parameters('environmentSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8606000514639709960"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the PostgreSQL server."
              }
            },
            "prefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for the PostgreSQL server name."
              }
            },
            "environmentSize": {
              "type": "string",
              "metadata": {
                "description": "The size of the environment."
              }
            },
            "adminPassword": {
              "type": "securestring",
              "defaultValue": "[newGuid()]"
            }
          },
          "variables": {
            "postgresServerName": "[format('{0}-postgres-{1}', parameters('prefix'), uniqueString(resourceGroup().id))]",
            "postgresDatabaseName": "proposalgen_db",
            "skus": {
              "Testing": {
                "name": "Standard_B1ms",
                "tier": "Burstable"
              },
              "Exploratory": {
                "name": "Standard_B1ms",
                "tier": "Burstable"
              },
              "Expanded": {
                "name": "Standard_D2s_v3",
                "tier": "GeneralPurpose"
              },
              "Organization-Wide": {
                "name": "Standard_D4s_v3",
                "tier": "GeneralPurpose"
              }
            }
          },
          "resources": {
            "postgresServer": {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2023-03-01-preview",
              "name": "[variables('postgresServerName')]",
              "location": "[parameters('location')]",
              "sku": "[variables('skus')[parameters('environmentSize')]]",
              "tags": {
                "Environment": "Dev"
              },
              "properties": {
                "administratorLogin": "psqladmin",
                "administratorLoginPassword": "[parameters('adminPassword')]",
                "version": "14",
                "storage": {
                  "storageSizeGB": 32
                },
                "backup": {
                  "backupRetentionDays": 7,
                  "geoRedundantBackup": "Disabled"
                },
                "network": {}
              }
            },
            "postgresDatabase": {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2023-03-01-preview",
              "name": "[format('{0}/{1}', variables('postgresServerName'), variables('postgresDatabaseName'))]",
              "dependsOn": [
                "postgresServer"
              ]
            },
            "pgvectorExtension": {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/configurations",
              "apiVersion": "2023-03-01-preview",
              "name": "[format('{0}/{1}', variables('postgresServerName'), 'azure.extensions')]",
              "properties": {
                "value": "VECTOR"
              },
              "dependsOn": [
                "postgresServer"
              ]
            }
          },
          "outputs": {
            "serverName": {
              "type": "string",
              "value": "[variables('postgresServerName')]"
            },
            "databaseName": {
              "type": "string",
              "value": "[variables('postgresDatabaseName')]"
            },
            "adminUser": {
              "type": "string",
              "value": "[reference('postgresServer').administratorLogin]"
            },
            "adminPassword": {
              "type": "securestring",
              "value": "[parameters('adminPassword')]"
            }
          }
        }
      }
    },
    "redis": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "redisDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "prefix": {
            "value": "[parameters('resourcePrefix')]"
          },
          "environmentSize": {
            "value": "[parameters('environmentSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2877703806609090226"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the Redis cache."
              }
            },
            "prefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for the Redis cache name."
              }
            },
            "environmentSize": {
              "type": "string",
              "metadata": {
                "description": "The size of the environment."
              }
            }
          },
          "variables": {
            "redisCacheName": "[format('{0}-redis-{1}', parameters('prefix'), uniqueString(resourceGroup().id))]"
          },
          "resources": {
            "redisCache": {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2023-04-01",
              "name": "[variables('redisCacheName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[if(or(equals(parameters('environmentSize'), 'Testing'), equals(parameters('environmentSize'), 'Exploratory')), 'Basic', 'Standard')]",
                "family": "C",
                "capacity": "[if(or(equals(parameters('environmentSize'), 'Testing'), equals(parameters('environmentSize'), 'Exploratory')), 0, 1)]"
              },
              "tags": {
                "Environment": "Dev"
              },
              "properties": {
                "enableNonSslPort": false,
                "publicNetworkAccess": "Enabled"
              }
            }
          },
          "outputs": {
            "hostName": {
              "type": "string",
              "value": "[reference('redisCache').hostName]"
            },
            "port": {
              "type": "int",
              "value": "[reference('redisCache').sslPort]"
            },
            "password": {
              "type": "securestring",
              "value": "[listKeys('redisCache', '2023-04-01').primaryKey]"
            }
          }
        }
      }
    },
    "openAi": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "openAiDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "prefix": {
            "value": "[parameters('resourcePrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7790398409816627799"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the Azure OpenAI service."
              }
            },
            "prefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for the Azure OpenAI service name."
              }
            }
          },
          "variables": {
            "openAiAccountName": "[format('{0}-openai-{1}', parameters('prefix'), uniqueString(resourceGroup().id))]"
          },
          "resources": {
            "openAiAccount": {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-02-01",
              "name": "[variables('openAiAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "S0"
              },
              "kind": "OpenAI",
              "tags": {
                "Environment": "Dev"
              },
              "properties": {
                "customSubDomainName": "[variables('openAiAccountName')]",
                "publicNetworkAccess": "Enabled"
              }
            },
            "gpt4Deployment": {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', variables('openAiAccountName'), 'gpt-4')]",
              "tags": {
                "Environment": "Dev"
              },
              "sku": {
                "name": "Standard",
                "capacity": 20
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4",
                  "version": "2024-12-17"
                }
              },
              "dependsOn": [
                "openAiAccount"
              ]
            },
            "embeddingDeployment": {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', variables('openAiAccountName'), 'text-embedding-ada-002')]",
              "tags": {
                "Environment": "Dev"
              },
              "sku": {
                "name": "Standard",
                "capacity": 20
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-ada-002",
                  "version": "2"
                }
              },
              "dependsOn": [
                "openAiAccount"
              ]
            }
          },
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[reference('openAiAccount').endpoint]"
            },
            "apiKey": {
              "type": "securestring",
              "value": "[listKeys('openAiAccount', '2024-02-01').key1]"
            }
          }
        }
      }
    },
    "containerEnv": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerEnvDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "prefix": {
            "value": "[parameters('resourcePrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10830901228819699008"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the container app environment."
              }
            },
            "prefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for the container app environment name."
              }
            }
          },
          "variables": {
            "containerAppEnvName": "[format('{0}-env-{1}', parameters('prefix'), uniqueString(resourceGroup().id))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2022-03-01",
              "name": "[variables('containerAppEnvName')]",
              "location": "[parameters('location')]",
              "tags": {
                "Environment": "Dev"
              },
              "properties": {}
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]"
            }
          }
        }
      }
    },
    "containerApps": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerAppsDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "prefix": {
            "value": "[parameters('resourcePrefix')]"
          },
          "containerRegistry": {
            "value": "[reference('acr').outputs.name.value]"
          },
          "postgresServerName": {
            "value": "[reference('postgres').outputs.serverName.value]"
          },
          "postgresDatabaseName": {
            "value": "[reference('postgres').outputs.databaseName.value]"
          },
          "postgresAdminUser": {
            "value": "[reference('postgres').outputs.adminUser.value]"
          },
          "postgresAdminPassword": {
            "value": "[listOutputsWithSecureValues('postgres', '2025-04-01').adminPassword]"
          },
          "redisHost": {
            "value": "[reference('redis').outputs.hostName.value]"
          },
          "redisPort": {
            "value": "[reference('redis').outputs.port.value]"
          },
          "redisPassword": {
            "value": "[listOutputsWithSecureValues('redis', '2025-04-01').password]"
          },
          "backendImage": {
            "value": "[parameters('backendImage')]"
          },
          "environmentId": {
            "value": "[reference('containerEnv').outputs.id.value]"
          },
          "openAiEndpoint": {
            "value": "[reference('openAi').outputs.endpoint.value]"
          },
          "openAiApiKey": {
            "value": "[listOutputsWithSecureValues('openAi', '2025-04-01').apiKey]"
          },
          "serperApiKey": {
            "value": "[parameters('serperApiKey')]"
          },
          "secretKey": {
            "value": "[parameters('secretKey')]"
          },
          "cfAccessClientId": {
            "value": "[parameters('cfAccessClientId')]"
          },
          "cfAccessClientSecret": {
            "value": "[parameters('cfAccessClientSecret')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7167288041403787325"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the container apps."
              }
            },
            "prefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for the container apps."
              }
            },
            "containerRegistry": {
              "type": "string",
              "metadata": {
                "description": "The name of the container registry."
              }
            },
            "postgresServerName": {
              "type": "string",
              "metadata": {
                "description": "The PostgreSQL server name."
              }
            },
            "postgresDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "The PostgreSQL database name."
              }
            },
            "postgresAdminUser": {
              "type": "string",
              "metadata": {
                "description": "The PostgreSQL admin user."
              }
            },
            "postgresAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The PostgreSQL admin password."
              }
            },
            "redisHost": {
              "type": "string",
              "metadata": {
                "description": "The Redis host name."
              }
            },
            "redisPort": {
              "type": "int",
              "metadata": {
                "description": "The Redis port."
              }
            },
            "redisPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The Redis password."
              }
            },
            "backendImage": {
              "type": "string",
              "metadata": {
                "description": "The Docker image for the backend app."
              }
            },
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the container app environment."
              }
            },
            "openAiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The Azure OpenAI endpoint."
              }
            },
            "openAiApiKey": {
              "type": "securestring",
              "metadata": {
                "description": "The Azure OpenAI API key."
              }
            },
            "serperApiKey": {
              "type": "securestring",
              "metadata": {
                "description": "The Serper API key."
              }
            },
            "secretKey": {
              "type": "securestring",
              "metadata": {
                "description": "The Django secret key."
              }
            },
            "cfAccessClientId": {
              "type": "string",
              "metadata": {
                "description": "Cloudflare Access Client ID."
              }
            },
            "cfAccessClientSecret": {
              "type": "securestring",
              "metadata": {
                "description": "Cloudflare Access Client Secret."
              }
            }
          },
          "variables": {
            "backendAppName": "[format('{0}-app', parameters('prefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2022-03-01",
              "name": "[variables('backendAppName')]",
              "location": "[parameters('location')]",
              "tags": {
                "Environment": "Dev"
              },
              "properties": {
                "managedEnvironmentId": "[parameters('environmentId')]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8000
                  },
                  "registries": [
                    {
                      "server": "[format('{0}.azurecr.io', parameters('containerRegistry'))]",
                      "username": "[parameters('containerRegistry')]",
                      "passwordSecretRef": "acr-password"
                    }
                  ],
                  "secrets": [
                    {
                      "name": "acr-password",
                      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistry')), '2022-02-01-preview').passwords[0].value]"
                    },
                    {
                      "name": "postgres-connection-string",
                      "value": "[format('postgresql://{0}:{1}@{2}.postgres.database.azure.com/{3}', parameters('postgresAdminUser'), parameters('postgresAdminPassword'), parameters('postgresServerName'), parameters('postgresDatabaseName'))]"
                    },
                    {
                      "name": "redis-connection-string",
                      "value": "[format('redis://default:{0}@{1}:{2}', parameters('redisPassword'), parameters('redisHost'), parameters('redisPort'))]"
                    },
                    {
                      "name": "openai-endpoint",
                      "value": "[parameters('openAiEndpoint')]"
                    },
                    {
                      "name": "openai-api-key",
                      "value": "[parameters('openAiApiKey')]"
                    },
                    {
                      "name": "serper-api-key",
                      "value": "[parameters('serperApiKey')]"
                    },
                    {
                      "name": "secret-key",
                      "value": "[parameters('secretKey')]"
                    },
                    {
                      "name": "cf-access-client-id",
                      "value": "[parameters('cfAccessClientId')]"
                    },
                    {
                      "name": "cf-access-client-secret",
                      "value": "[parameters('cfAccessClientSecret')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "image": "[format('{0}.azurecr.io/{1}', parameters('containerRegistry'), parameters('backendImage'))]",
                      "name": "backend",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1.0Gi"
                      },
                      "env": [
                        {
                          "name": "DATABASE_URL",
                          "secretRef": "postgres-connection-string"
                        },
                        {
                          "name": "REDIS_URL",
                          "secretRef": "redis-connection-string"
                        },
                        {
                          "name": "AZURE_OPENAI_ENDPOINT",
                          "secretRef": "openai-endpoint"
                        },
                        {
                          "name": "AZURE_OPENAI_API_KEY",
                          "secretRef": "openai-api-key"
                        },
                        {
                          "name": "SERPER_API_KEY",
                          "secretRef": "serper-api-key"
                        },
                        {
                          "name": "SECRET_KEY",
                          "secretRef": "secret-key"
                        },
                        {
                          "name": "CF_ACCESS_CLIENT_ID",
                          "secretRef": "cf-access-client-id"
                        },
                        {
                          "name": "CF_ACCESS_CLIENT_SECRET",
                          "secretRef": "cf-access-client-secret"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 3
                  }
                }
              }
            }
          ],
          "outputs": {
            "appUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', variables('backendAppName')), '2022-03-01').configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "acr",
        "containerEnv",
        "openAi",
        "postgres",
        "redis"
      ]
    }
  },
  "outputs": {
    "acrName": {
      "type": "string",
      "value": "[reference('acr').outputs.name.value]"
    },
    "postgresServerName": {
      "type": "string",
      "value": "[reference('postgres').outputs.serverName.value]"
    },
    "containerAppUrl": {
      "type": "string",
      "value": "[reference('containerApps').outputs.appUrl.value]"
    }
  }
}