
# .github/workflows/deploy.yml
name: Build and Deploy

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP: 'rg-ppg'
  LOCATION: 'northeurope'
  ACR_NAME: 'ppgacr' # Should be globally unique

jobs:
  build-and-push:
    name: 'Build and Push Docker Image'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v3

    - name: 'Login to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Build and Push Backend Image'
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    - run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} .
        docker push ${{ env.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}

  deploy-infrastructure:
    name: 'Deploy Bicep Infrastructure'
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v3

    - name: 'Login to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Deploy Bicep File'
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: ${{ env.RESOURCE_GROUP }}
        template: ./infrastructure/main.bicep
        parameters: >
          backendImage=backend:${{ github.sha }}
          serperApiKey=${{ secrets.SERPER_API_KEY }}
          entraTenantId=${{ secrets.ENTRA_TENANT_ID }}
          entraClientId=${{ secrets.ENTRA_CLIENT_ID }}
          entraClientSecret=${{ secrets.ENTRA_CLIENT_SECRET }}
        failOnStdErr: false
